<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —ç–º–æ–¥–∑–∏</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.10.2/lottie.min.js"></script>
<style>
:root{
  --bg:#0f1220; --card:#171a2a; --text:#e8ebff; --muted:#9aa3c7;
  --accent:#6ea8ff; --accent-2:#7b6cff; --btn:#2a2f45; --btn-hover:#343a55;
  --shadow:0 10px 30px rgba(0,0,0,0.25); --radius:18px;
  --green:#22c55e; --orange:#ff9800; --red:#ff4d4f;
}
*{box-sizing:border-box}
body{margin:0; font-family:sans-serif; background:var(--bg); color:var(--text);}
.wrap{max-width:1000px; margin:0 auto; padding:16px;}
header{display:flex; justify-content:space-between; align-items:center; padding:16px;}
h1{font-size:20px; margin:0;}
.grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:16px;}
.card{
  background:var(--card); border-radius:var(--radius); padding:14px;
  box-shadow:var(--shadow); display:flex; flex-direction:column; gap:10px;
  text-align:center; align-items:center; position:relative; overflow:hidden;
  transition:transform .2s ease, box-shadow .2s ease, border .2s ease;
}
.card:hover{transform:translateY(-2px); box-shadow:0 15px 35px rgba(0,0,0,.35);}
.card.hit{border:2px solid var(--orange);}
.card.discount{border:2px solid var(--green);}
.ribbon{
  position:absolute; top:12px; right:-34px; width:110px; height:24px;
  background:var(--orange); color:#fff; font-weight:700; text-align:center;
  line-height:24px; transform:rotate(45deg); z-index:10; font-size:12px;
  box-shadow:0 2px 5px rgba(0,0,0,.3);
}
.ribbon.discount{background:var(--green);}
.emoji-box{
  aspect-ratio:1/1; border-radius:14px; background:#1e2235;
  display:flex; justify-content:center; align-items:center; width:100%;
  overflow:hidden; position:relative;
}
.emoji-box img{max-width:80%; max-height:80%; display:block; margin:auto;}
.anim-box{
  position:absolute; inset:0; display:flex; justify-content:center; align-items:center;
  pointer-events:none; display:none;
}
.anim-box svg{width:80% !important; height:80% !important;}
.name{font-size:15px; font-weight:600;}
.price{font-size:14px;}
.old-price{text-decoration:line-through; color:var(--muted); margin-right:6px;}
.new-price{color:var(--green); font-weight:700;}
.btn{
  margin-top:4px; padding:10px 12px; border-radius:12px;
  background:linear-gradient(135deg,var(--accent),var(--accent-2));
  color:#fff; border:none; font-weight:700; cursor:pointer; box-shadow:var(--shadow);
}
.floating-cart{
  position:fixed; bottom:16px; right:16px;
  background:linear-gradient(135deg,var(--accent),var(--accent-2));
  color:#fff; border:none; border-radius:50%; width:64px; height:64px;
  display:flex; justify-content:center; align-items:center; font-size:24px; font-weight:700;
  box-shadow:var(--shadow); cursor:pointer; z-index:999; text-decoration:none; gap:6px;
}
.badge{
  position:absolute; top:-6px; right:-6px; min-width:22px; height:22px; padding:0 6px;
  background:var(--red); color:#fff; border-radius:999px; font-size:12px;
  display:flex; align-items:center; justify-content:center; box-shadow:0 2px 6px rgba(0,0,0,.4);
}
.floating-cart:hover{opacity:.92;}
</style>
</head>
<body>
<header class="wrap">
  <h1>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ Telegram —ç–º–æ–¥–∑–∏</h1>
</header>

<main class="wrap">
  <div class="grid" id="grid"></div>
</main>

<a href="cart.html" class="floating-cart" id="cartBtn" aria-label="–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É">
  üõí
  <span class="badge" id="cartCount">0</span>
</a>

<script>
const items = [
  {id:"Flag1", name:"–§–ª–∞–≥"},
  {id:"Phone", name:"–¢–µ–ª–µ—Ñ–æ–Ω"},
  {id:"Card", name:"–ö–∞—Ä—Ç–æ—á–∫–∞"},
  {id:"Case", name:"–ö–µ–π—Å"},
  {id:"HeartArms", name:"–°–µ—Ä–¥—Ü–µ"},
  {id:"TopSign", name:"–¢–û–ü"},
];

// –≤—ã–¥–µ–ª–µ–Ω–∏–µ
const hits = ["HeartArms"];
const discounts = ["TopSign"]; // -20%

const PRICE = 0.8;
const grid = document.getElementById("grid");

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –∞–Ω–∏–º–∞—Ü–∏–π —Å —Ñ–ª–∞–≥–∞–º–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏/–æ—à–∏–±–∫–∏
const animations = {}; // id -> {anim, ready:boolean, failed:boolean}

function cleanCartSchema(arr){
  // —É–±–∏—Ä–∞–µ–º –±–∏—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π
  return (Array.isArray(arr)?arr:[]).filter(x => x && x.item && x.item.id && typeof x.price === 'number');
}
function getCart(){
  const raw = JSON.parse(localStorage.getItem("cart")||"[]");
  const cleaned = cleanCartSchema(raw);
  if (cleaned.length !== raw.length) localStorage.setItem("cart", JSON.stringify(cleaned));
  return cleaned;
}
function saveCart(cart){
  localStorage.setItem("cart", JSON.stringify(cleanCartSchema(cart)));
  updateCartCount();
}

function updateCartCount(){
  document.getElementById('cartCount').textContent = getCart().length;
}

function toggleCart(item){
  let cart = getCart();
  const idx = cart.findIndex(c=>c.item.id===item.id);
  if(idx>=0){
    cart.splice(idx,1);
  }else{
    let price = PRICE;
    if(discounts.includes(item.id)) price = +(PRICE*0.8).toFixed(2);
    cart.push({item, price});
  }
  saveCart(cart);
  render(); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏
}

function render(){
  const cart = getCart();
  const sorted = [...items].sort((a,b)=>{
    const aScore = (hits.includes(a.id)?2:0) + (discounts.includes(a.id)?1:0);
    const bScore = (hits.includes(b.id)?2:0) + (discounts.includes(b.id)?1:0);
    return bScore - aScore;
  });

  grid.innerHTML = sorted.map(item=>{
    const inCart = cart.some(c=>c.item.id===item.id);
    const isHit = hits.includes(item.id);
    const isDiscount = discounts.includes(item.id);
    const ribbon = isHit ? '<div class="ribbon">–•–ò–¢</div>' : (isDiscount ? '<div class="ribbon discount">–°–ö–ò–î–ö–ê</div>' : '');
    const priceHTML = isDiscount
      ? `<div class="price"><span class="old-price">$${PRICE.toFixed(2)}</span><span class="new-price">$${(PRICE*0.8).toFixed(2)}</span></div>`
      : `<div class="price">$${PRICE.toFixed(2)}</div>`;

    return `
      <div class="card ${isHit?'hit':''} ${isDiscount?'discount':''}">
        ${ribbon}
        <div class="emoji-box" id="box-${item.id}">
          <img src="${item.id}.png" alt="${item.name}">
          <div class="anim-box" id="anim-${item.id}"></div>
        </div>
        <div class="name">${item.name}</div>
        ${priceHTML}
        <button class="btn" onclick='toggleCart(${JSON.stringify(item)})'>${inCart?'–£–±—Ä–∞—Ç—å':'–î–æ–±–∞–≤–∏—Ç—å'}</button>
      </div>
    `;
  }).join('');

  preloadAnimations();
  bindAnimations();
  updateCartCount();
}

function preloadAnimations(){
  items.forEach(item=>{
    const animBox = document.getElementById(`anim-${item.id}`);
    if(!animBox) return;
    if(animations[item.id]) return; // —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ

    const anim = lottie.loadAnimation({
      container: animBox,
      renderer: "svg",
      loop: false,
      autoplay: false,
      path: `${item.id}.json`
    });

    animations[item.id] = {anim, ready:false, failed:false};

    // —É—Å–ø–µ—Ö –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∏–º–∞—Ü–∏–∏
    anim.addEventListener('data_ready', ()=>{ animations[item.id].ready = true; animBox.style.display = 'none'; });
    // –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
    anim.addEventListener('data_failed', ()=>{ animations[item.id].failed = true; animBox.style.display='none'; });
  });
}

function bindAnimations(){
  items.forEach(item=>{
    const box = document.getElementById(`box-${item.id}`);
    if(!box) return;
    const img = box.querySelector('img');
    const animBox = document.getElementById(`anim-${item.id}`);
    const entry = animations[item.id];

    // –°–Ω–∏–º–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–Ω–∞ —Å–ª—É—á–∞–π –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–∏)
    const handler = ()=>{
      // –∏–≥—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∞–Ω–∏–º–∞—Ü–∏—è —Ä–µ–∞–ª—å–Ω–æ –≥–æ—Ç–æ–≤–∞
      if(!entry || entry.failed || !entry.ready) return;
      if(animBox.dataset.playing==="true") return;

      animBox.dataset.playing = "true";
      img.style.display = 'none';
      animBox.style.display = 'flex';
      entry.anim.goToAndPlay(0, true);

      entry.anim.addEventListener('complete', ()=>{
        animBox.style.display = 'none';
        img.style.display = 'block';
        animBox.dataset.playing = "false";
      }, { once: true });
    };

    // –ß—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–∏ re-render, —Å–Ω–∞—á–∞–ª–∞ –∫–ª–æ–Ω–∏—Ä—É–µ–º —É–∑–µ–ª
    const clone = box.cloneNode(true);
    box.replaceWith(clone);

    // –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∞–µ–º —Å—Å—ã–ª–∫–∏
    const newBox = document.getElementById(`box-${item.id}`);
    const newImg = newBox.querySelector('img');
    const newAnimBox = document.getElementById(`anim-${item.id}`);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞/—Ç–∞—á–∞
    ["click","touchstart"].forEach(ev=>{
      newBox.addEventListener(ev, ()=>{
        if(!entry || entry.failed || !entry.ready) return; // –Ω–µ—Ç json ‚Äî –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä
        if(newAnimBox.dataset.playing==="true") return;

        newAnimBox.dataset.playing = "true";
        newImg.style.display = 'none';
        newAnimBox.style.display = 'flex';
        entry.anim.wrapper = newAnimBox; // —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–∫—Ç—É–∞–ª–µ–Ω
        entry.anim.goToAndPlay(0, true);

        entry.anim.addEventListener('complete', ()=>{
          newAnimBox.style.display = 'none';
          newImg.style.display = 'block';
          newAnimBox.dataset.playing = "false";
        }, { once: true });
      });
    });
  });
}

render();
</script>
</body>
</html>
