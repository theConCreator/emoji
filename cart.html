<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —ç–º–æ–¥–∑–∏ ‚Äî –ö–æ—Ä–∑–∏–Ω–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0f1220;--card:#171a2a;--text:#e8ebff;--muted:#9aa3c7;--accent:#6ea8ff;--accent-2:#7b6cff;--radius:12px}
*{box-sizing:border-box;font-family:'Inter',sans-serif}
body{margin:0;background:var(--bg);color:var(--text);padding:18px}
.container{max-width:820px;margin:0 auto}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
h1{margin:0}
.list{display:flex;flex-direction:column;gap:12px;margin-bottom:12px}
.item{display:flex;align-items:center;gap:12px;background:var(--card);padding:10px;border-radius:10px;box-shadow:0 8px 22px rgba(0,0,0,0.35)}
.thumb{width:72px;height:72px;border-radius:8px;background:rgba(255,255,255,0.02);display:grid;place-items:center;overflow:hidden}
.meta{flex:1}
.remove{background:#ff5a5f;border:none;padding:8px 10px;border-radius:8px;color:#fff;cursor:pointer}
.form{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 8px 22px rgba(0,0,0,0.35);display:flex;flex-direction:column;gap:10px}
input[type="text"], input[type="url"]{padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.02);color:var(--text)}
.color-row{display:flex;gap:8px;align-items:center}
.color-row input[type="color"]{width:46px;height:36px;border:none;padding:0;background:transparent;cursor:pointer}
.btn{padding:10px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:700;cursor:pointer}
.small{font-size:13px;color:var(--muted)}
.toggle-on{background:#29a37a}
.note{font-size:13px;color:var(--muted)}
.total{font-weight:800}
.actions{display:flex;gap:10px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>–ö–æ—Ä–∑–∏–Ω–∞</h1>
    <a href="index.html" class="small" style="color:var(--accent)">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞—Ç–∞–ª–æ–≥—É</a>
  </div>

  <div id="list" class="list"></div>
  <div id="total" class="total" style="margin-bottom:14px"></div>

  <div class="form">
    <label>–ù–∏–∫ (Telegram –±–µ–∑ @):
      <input id="nick" type="text" placeholder="theUser">
    </label>

    <div class="color-row">
      <div style="min-width:130px" class="small">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç (–∑–∞–ª–∏–≤–∫–∞)</div>
      <input id="mainColor" type="color" value="#000000">
      <input id="mainColorText" type="text" placeholder="#rrggbb" value="#000000" style="flex:1">
    </div>

    <div class="color-row">
      <div style="min-width:130px" class="small">–í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π (–æ–±–≤–æ–¥–∫–∞/–ª–æ–≥–æ)</div>
      <input id="secondaryColor" type="color" value="#ffffff">
      <input id="secondaryColorText" type="text" placeholder="#rrggbb" value="#ffffff" style="flex:1">
    </div>

    <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –ª–æ–≥–æ—Ç–∏–ø (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
      <input id="logoUrl" type="url" placeholder="https://example.com/logo.png">
    </label>

    <div class="actions">
      <button id="logoToggle" type="button" class="btn" style="background:var(--card);color:var(--text);box-shadow:none">–û—Ç–ø—Ä–∞–≤–ª—é –ª–æ–≥–æ—Ç–∏–ø –≤ Telegram</button>
      <button id="clearCartBtn" type="button" class="btn" style="background:#2b2f3f">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
    </div>
    <div class="note">–ï—Å–ª–∏ –≤—ã–±–µ—Ä–µ—Ç–µ ¬´–û—Ç–ø—Ä–∞–≤–ª—é –ª–æ–≥–æ—Ç–∏–ø –≤ Telegram¬ª, –ø–æ–ª–µ —Å—Å—ã–ª–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –∏ –≤ –∑–∞–∫–∞–∑–µ –ø–æ—è–≤–∏—Ç—Å—è –æ—Ç–º–µ—Ç–∫–∞.</div>

    <button id="send" class="btn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –∏ –æ—Ç–∫—Ä—ã—Ç—å Telegram</button>
  </div>
</div>

<script>
/* Normalization helpers */
function rawCart(){ try { return JSON.parse(localStorage.getItem('cart')||'[]'); } catch(e){ return []; } }
function normalizeEntry(e){
  if(!e) return null;
  if(e.id && e.name) return {id:String(e.id), name:String(e.name), price:Number(e.price||0)};
  if(e.item){ const it=e.item; return {id:String(it.id||it.name||'unknown'), name:String(it.name||it.id||'Unknown'), price:Number(e.price||it.price||0)}; }
  const id = e.id||e.itemId||e.name||Object.values(e)[0]||'unknown';
  const name = e.name||e.title||id;
  const price = Number(e.price||0);
  return {id:String(id), name:String(name), price:price};
}
function getCart(){ const normalized = rawCart().map(normalizeEntry).filter(Boolean); try{ localStorage.setItem('cart', JSON.stringify(normalized)); }catch(e){} return normalized; }
function setCart(arr){ localStorage.setItem('cart', JSON.stringify(arr)); renderList(); }

/* UI elements */
const listEl = document.getElementById('list');
const totalEl = document.getElementById('total');
const mainColor = document.getElementById('mainColor');
const mainColorText = document.getElementById('mainColorText');
const secondaryColor = document.getElementById('secondaryColor');
const secondaryColorText = document.getElementById('secondaryColorText');
const logoToggle = document.getElementById('logoToggle');
const logoUrl = document.getElementById('logoUrl');
let logoWillBeSent = false;

/* sync color pickers and text */
mainColor.addEventListener('input', ()=> mainColorText.value = mainColor.value);
mainColorText.addEventListener('input', ()=> { if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(mainColorText.value.trim())) mainColor.value = mainColorText.value.trim(); });
secondaryColor.addEventListener('input', ()=> secondaryColorText.value = secondaryColor.value);
secondaryColorText.addEventListener('input', ()=> { if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(secondaryColorText.value.trim())) secondaryColor.value = secondaryColorText.value.trim(); });

/* logo toggle */
logoToggle.addEventListener('click', ()=>{
  logoWillBeSent = !logoWillBeSent;
  if(logoWillBeSent){ logoUrl.value=''; logoUrl.disabled=true; logoToggle.classList.add('toggle-on'); logoToggle.textContent='–û—Ç–º–µ—á–µ–Ω–æ: –ø—Ä–∏—à–ª—é –ª–æ–≥–æ—Ç–∏–ø –≤ Telegram'; }
  else { logoUrl.disabled=false; logoToggle.classList.remove('toggle-on'); logoToggle.textContent='–û—Ç–ø—Ä–∞–≤–ª—é –ª–æ–≥–æ—Ç–∏–ø –≤ Telegram'; }
});

/* render list */
async function existsURL(url){
  try{ const r = await fetch(url, {method:'GET'}); return r.ok; } catch(e){ return false; }
}

async function renderList(){
  const cart = getCart();
  listEl.innerHTML='';
  if(cart.length === 0){
    listEl.innerHTML = '<div class="note">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>';
    totalEl.textContent='';
    return;
  }
  let sum = 0;
  cart.forEach(async (item, idx)=>{
    const row = document.createElement('div'); row.className='item';
    const thumb = document.createElement('div'); thumb.className='thumb'; row.appendChild(thumb);
    const png = `${item.id}.png`;
    if(await existsURL(png)){
      const img = document.createElement('img'); img.src=png; img.alt=item.name; img.style.maxWidth='100%'; img.style.maxHeight='100%'; thumb.appendChild(img);
    } else {
      thumb.innerHTML = `<div style="padding:6px;color:var(--muted);text-align:center">${escapeHtml(item.name)}</div>`;
    }
    const meta = document.createElement('div'); meta.className='meta'; meta.innerHTML=`<div style="font-weight:700">${escapeHtml(item.name)}</div><div class="small">–§–∞–π–ª: ${escapeHtml(item.id)}.json / ${escapeHtml(item.id)}.png</div>`;
    row.appendChild(meta);
    const removeBtn = document.createElement('button'); removeBtn.className='remove'; removeBtn.textContent='–£–¥–∞–ª–∏—Ç—å'; removeBtn.addEventListener('click', ()=>{ const newCart = getCart().filter((_,i)=>i!==idx); setCart(newCart); });
    row.appendChild(removeBtn);
    listEl.appendChild(row);
    sum += Number(item.price||0);
    totalEl.textContent = `–ò—Ç–æ–≥–æ: $${sum.toFixed(2)}`;
  });
}

/* escape helper */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* clear cart */
document.getElementById('clearCartBtn').addEventListener('click', ()=>{ if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')){ setCart([]); } });

/* send order */
document.getElementById('send').addEventListener('click', async ()=>{
  const cart = getCart();
  if(cart.length === 0){ alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); return; }
  const nickRaw = document.getElementById('nick').value.trim();
  const nick = nickRaw ? (nickRaw.startsWith('@') ? nickRaw : '@'+nickRaw) : '-';
  const main = mainColor.value || mainColorText.value || '-';
  const secondary = secondaryColor.value || secondaryColorText.value || '-';
  const logo = logoWillBeSent ? '(–±—É–¥–µ—Ç –ø—Ä–∏—Å–ª–∞–Ω –≤ Telegram)' : (logoUrl.value.trim() || '(–Ω–µ —É–∫–∞–∑–∞–Ω)');

  const lines = [];
  lines.push('üõí –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –æ—Ç —Å–∞–π—Ç–∞ —ç–º–æ–¥–∑–∏');
  lines.push('');
  lines.push('–≠–º–æ–¥–∑–∏:');
  cart.forEach(c => lines.push(`‚Ä¢ ${c.name} ‚Äî —Ñ–∞–π–ª: ${c.id}.json / ${c.id}.png ‚Äî $${Number(c.price||0).toFixed(2)}`));
  lines.push('');
  lines.push(`–ù–∏–∫: ${nick}`);
  lines.push(`–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç: ${main}`);
  lines.push(`–í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç: ${secondary}`);
  lines.push(`–õ–æ–≥–æ—Ç–∏–ø: ${logo}`);
  lines.push('');
  lines.push(`–ò—Ç–æ–≥–æ: $${cart.reduce((s,c)=>s+Number(c.price||0),0).toFixed(2)}`);
  lines.push('');
  lines.push('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—à–ª–∏—Ç–µ —Ñ–∞–π–ª –ª–æ–≥–æ—Ç–∏–ø–∞ –≤ Telegram, –µ—Å–ª–∏ –≤—ã –æ—Ç–º–µ—Ç–∏–ª–∏, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ –µ–≥–æ –≤ —á–∞—Ç–µ.');

  const text = lines.join('\n');
  const encoded = encodeURIComponent(text);
  const username = 'theConCreator';
  const deep = `tg://resolve?domain=${encodeURIComponent(username)}&text=${encoded}`;
  const web = `https://t.me/${encodeURIComponent(username)}?text=${encoded}`;

  // Try to open tg:// then fallback to https
  window.location.href = deep;
  setTimeout(()=>{ window.location.href = web; }, 800);
});

/* init */
(function init(){ /* normalize storage */ const norm = getCart(); localStorage.setItem('cart', JSON.stringify(norm)); renderList(); })();
</script>
</body>
</html>
