<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GiftsMine üéÅ</title>
<style>
body{margin:0;font-family:Segoe UI,sans-serif;color:#fff;display:flex;flex-direction:column;height:100vh;user-select:none;overflow:hidden;background-size:cover;background-position:center;background-repeat:no-repeat;opacity:0;transition:opacity 0.6s ease;}
#balance{padding:15px;text-align:right;font-size:1.2em;font-weight:bold;background:rgba(0,0,0,0.15);backdrop-filter:blur(5px);position:relative;box-shadow:0 2px 8px rgba(0,0,0,0.3);}
main{flex:1;overflow-y:auto;padding:10px;display:none;background: rgba(0,0,0,0.2);}
main.active{display:block;}
.tab-bar{display:flex;justify-content:space-around;background: rgba(0,0,0,0.2);padding:10px;border-top:2px solid #fff;}
.tab-bar button{flex:1;margin:0 5px;padding:10px;border:none;background:linear-gradient(135deg,#ff9a9e,#fad0c4);color:#fff;font-weight:bold;cursor:pointer;transition:0.3s;}
.tab-bar button.active{background:linear-gradient(135deg,#a1c4fd,#c2e9fb);color:#fff;}
.grid{display:grid;gap:5px;justify-content:center;}
.mines-grid{grid-template-columns: repeat(5, minmax(50px,1fr));}
.mine-cell,.block{aspect-ratio:1/1;background:#333;border-radius:0;display:flex;align-items:center;justify-content:center;font-size:0.9em;font-weight:bold;cursor:pointer;transition:0.2s;touch-action:none;box-shadow:0 2px 6px rgba(0,0,0,0.2);position:relative;overflow:hidden;background-size:cover;background-position:center;}
.mine-cell.disabled{pointer-events:none;opacity:0.6;}
.mine-cell.revealed.safe{background:#4caf50;}
.mine-cell.revealed.mine{background:#f44336;}
.block-price{position:absolute;bottom:2px;right:2px;background:rgba(0,0,0,0.5);padding:2px 4px;font-size:0.7em;border-radius:2px;display:flex;align-items:center;gap:2px;}
.block.cooldown{filter:brightness(0.5);cursor:not-allowed;}
.inventory-list{display:flex;flex-wrap:wrap;gap:10px;}
.gift-item{background:#222;padding:10px;box-shadow:0 6px 16px rgba(0,0,0,0.5);font-size:0.9em;flex:1 1 45%;display:flex;align-items:center;gap:10px;transition:0.3s;position:relative;color:#fff;}
.gift-preview{width:50px;height:50px;}
.inv-actions{margin-left:auto;display:flex;flex-direction:column;gap:5px;}
.inv-actions button{background:linear-gradient(135deg,#ff9a9e,#fad0c4);border:none;padding:5px 8px;color:#fff;font-size:0.8em;border-radius:6px;cursor:pointer;}
.stake-options{margin-bottom:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
#mineReward{border:2px dashed #aaa;padding:10px;margin-left:10px;border-radius:10px;min-width:150px;text-align:center;font-weight:bold;position:relative;color:#fff;}
button#collectReward{padding:10px;background:linear-gradient(135deg,#ff9a9e,#fad0c4);border:none;color:#fff;font-weight:bold;cursor:pointer;border-radius:8px;margin-left:10px;transition:0.3s;}
button#collectReward:hover{background:linear-gradient(135deg,#a1c4fd,#c2e9fb);}
#loader{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999;background:#000;transition:opacity 0.6s ease;color:#fff;}
#loader.hidden{opacity:0;pointer-events:none;}
#loaderAnimation{width:150px;height:150px;margin-bottom:20px;}
.flying{position:absolute;width:80px;height:80px;pointer-events:none;z-index:1000;}
</style>
</head>
<body>

<div id="loader">
  <div id="loaderAnimation"></div>
  <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤...</p>
</div>

<div id="balance">–ë–∞–ª–∞–Ω—Å: 10000 <img src="ton.svg" style="width:16px;vertical-align:middle"></div>

<main id="menu" class="active">
<h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
<p>–í—ã–±–∏—Ä–∞–π —Ä–µ–∂–∏–º –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –ø–æ–¥–∞—Ä–∫–∏!</p>
</main>

<main id="mines">
<h2>–ú–∏–Ω—ã üí£</h2>
<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
<div class="stake-options">
<label><input type="radio" name="stakeType" value="ton" checked onchange="updateStakeInput()"> TON</label>
<label><input type="radio" name="stakeType" value="gift" onchange="updateStakeInput()"> –ü–æ–¥–∞—Ä–æ–∫</label>
<input type="number" id="tonStake" min="0.5" step="0.1" placeholder="–°—Ç–∞–≤–∫–∞ TON">
<select id="giftStake" style="display:none"></select>
<button onclick="startMines()">–ò–≥—Ä–∞—Ç—å</button>
</div>
<div>
<div id="mineReward">–í—ã–∏–≥—Ä—ã—à: ‚Äì</div>
<button id="collectReward" onclick="collectReward()">–ó–∞–±—Ä–∞—Ç—å</button>
</div>
</div>
<div class="grid mines-grid" id="minesGrid"></div>
<p id="minesStatus"></p>
</main>

<main id="mine">
<h2>–®–∞—Ö—Ç–∞ ‚õèÔ∏è</h2>
<div class="grid" id="mineGrid" style="grid-template-columns:repeat(4,minmax(60px,1fr))"></div>
</main>

<main id="inventory">
<h2>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å üéí</h2>
<div class="inventory-list" id="inventoryList"></div>
</main>

<div class="tab-bar">
<button onclick="showTab('menu')" id="tab-menu" class="active">–ú–µ–Ω—é</button>
<button onclick="showTab('mines')" id="tab-mines">–ú–∏–Ω—ã</button>
<button onclick="showTab('mine')" id="tab-mine">–®–∞—Ö—Ç–∞</button>
<button onclick="showTab('inventory')" id="tab-inventory">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.10.2/lottie.min.js"></script>
<script>
// –õ–æ–∞–¥–µ—Ä
lottie.loadAnimation({
  container:document.getElementById('loaderAnimation'),
  renderer:'svg',
  loop:true,
  autoplay:true,
  path:'animations/myLoader.json'
});

// –ë–∞–ª–∞–Ω—Å
let balance=10000;
function updateBalance(){
  document.getElementById('balance').innerHTML=`–ë–∞–ª–∞–Ω—Å: ${balance.toFixed(2)} <img src="ton.svg" style="width:16px;vertical-align:middle">`;
}

// –í–∫–ª–∞–¥–∫–∏
const backgrounds={menu:'images/menu.jpg',mines:'images/mines.jpg',mine:'images/mine.jpg',inventory:'images/inventory.jpg'};
function showTab(id){
    document.querySelectorAll('main').forEach(m=>m.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.tab-bar button').forEach(b=>b.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    document.body.style.backgroundImage=`url(${backgrounds[id]})`;
    if(id==='inventory') renderInventory();
}

// --- –ü–æ–¥–∞—Ä–∫–∏ ---
const gifts=[ /* ‚Üê —Å–ø–∏—Å–æ–∫ —Ç–≤–æ–π –ø–æ–ª–Ω—ã–π, —è –æ—Å—Ç–∞–≤–∏–ª –µ–≥–æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */ 
  {name:"Hypno Lollipop",price:1.77}, {name:"Desk Calendar",price:1.31}, {name:"B-Day Candle",price:1.32}, {name:"Lol Pop",price:1.32},
  {name:"Snake Box",price:1.36}, {name:"Lunar Snake",price:1.38}, {name:"Xmas Stocking",price:1.38}, {name:"Whip Cupcake",price:1.38},
  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–æ Plush Pepe
  {name:"Plush Pepe",price:5199}
];
let inventory=[];

// === –®–∞—Ö—Ç–∞ ===
const oreTypes=[
  {img:"images/ores/coal.png",hits:3},
  {img:"images/ores/iron.png",hits:4},
  {img:"images/ores/gold.png",hits:5},
  {img:"images/ores/diamond.png",hits:6},
  {img:"images/ores/emerald.png",hits:7}
];

function getGiftByPrice(price,isFirst=false){
  let min=price*0.5, max=price*1.5; // +10% –≤–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞
  let possible=gifts.filter(g=>g.price>=min&&g.price<=max);
  if(isFirst){ // –ø–µ—Ä–≤—ã–π –±–ª–æ–∫ ‚Üí –±–æ–ª—å—à–µ —à–∞–Ω—Å –¥–æ—Ä–æ–≥–æ–≥–æ
    possible=gifts.filter(g=>g.price>=price);
    if(possible.length===0) possible=gifts;
  }
  if(possible.length===0) possible=gifts;
  return possible[Math.floor(Math.random()*possible.length)];
}

function spawnBlock(cell,index=0){
  const ore=oreTypes[Math.floor(Math.random()*oreTypes.length)];
  let price=+(1+Math.random()*11).toFixed(2);
  cell.className="block";
  cell.style.backgroundImage=`url(${ore.img})`;
  cell.innerHTML=`<div class="block-price">${price}<img src="ton.svg" style="width:12px;vertical-align:middle"></div>`;
  let hits=0;
  cell.onclick=()=>{
    hits++;
    if(hits>=ore.hits){
      if(balance>=price){
        balance-=price; updateBalance();
        let gift=getGiftByPrice(price,index===0);
        inventory.push(gift); renderInventory();
        flyGift(gift,cell);
      }
      let respawn=(60+Math.random()*1740)*1000; // 1‚Äì30 –º–∏–Ω
      cell.classList.add("cooldown");
      cell.innerHTML=`<div style="position:absolute;top:2px;left:2px;font-size:0.7em;">${Math.round(respawn/60000)}m</div>`;
      cell.onclick=null;
      setTimeout(()=>{cell.classList.remove("cooldown"); spawnBlock(cell,index);},respawn);
    }
  };
}

function generateMineGrid(){
  const grid=document.getElementById("mineGrid"); grid.innerHTML="";
  for(let i=0;i<16;i++){
    let cell=document.createElement("div");
    spawnBlock(cell,i);
    grid.appendChild(cell);
  }
}

// –ê–Ω–∏–º–∞—Ü–∏—è –≤—ã–ª–µ—Ç–∞ –ø–æ–¥–∞—Ä–∫–∞
function flyGift(gift,fromCell){
  const rect=fromCell.getBoundingClientRect();
  const fly=document.createElement("div");
  fly.className="flying";
  fly.style.left=rect.left+"px";
  fly.style.top=rect.top+"px";
  document.body.appendChild(fly);
  lottie.loadAnimation({container:fly,renderer:"svg",loop:false,autoplay:true,path:`animations/${gift.name}.json`});
  let inv=document.getElementById("tab-inventory").getBoundingClientRect();
  fly.animate([{transform:`translate(0,0)`},{transform:`translate(${inv.left-rect.left}px,${inv.top-rect.top}px)`}],{duration:1000,easing:"ease-in-out"});
  setTimeout(()=>fly.remove(),1000);
}

// === –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å ===
function renderInventory(){
  let list=document.getElementById("inventoryList");
  list.innerHTML="";
  inventory.forEach((gift,i)=>{
    let div=document.createElement("div");
    div.className="gift-item";
    let prev=document.createElement("div");
    prev.className="gift-preview";
    lottie.loadAnimation({container:prev,renderer:"svg",loop:false,autoplay:true,path:`animations/${gift.name}.json`});
    let info=document.createElement("div");
    info.innerHTML=`${gift.name} ‚Äì ${gift.price} <img src="ton.svg" style="width:14px;vertical-align:middle">`;
    let actions=document.createElement("div");
    actions.className="inv-actions";
    let sell=document.createElement("button");
    sell.textContent="–ü—Ä–æ–¥–∞—Ç—å";
    sell.onclick=()=>{balance+=gift.price;inventory.splice(i,1);updateBalance();renderInventory();};
    let withdraw=document.createElement("button");
    withdraw.textContent="–í—ã–≤–µ—Å—Ç–∏";
    withdraw.onclick=()=>alert("–§—É–Ω–∫—Ü–∏—è –≤—ã–≤–æ–¥–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ");
    actions.appendChild(sell);actions.appendChild(withdraw);
    div.appendChild(prev);div.appendChild(info);div.appendChild(actions);
    list.appendChild(div);
  });
}

// === –ú–∏–Ω—ã === (–æ—Å—Ç–∞–≤–∏–ª –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
let minesActive=false, minesLost=false, mineMultiplier=1, currentStake=0;
function generateMines(){
  const grid=document.getElementById("minesGrid"); grid.innerHTML="";
  let mines=[]; while(mines.length<5){let idx=Math.floor(Math.random()*25); if(!mines.includes(idx)) mines.push(idx);}
  for(let i=0;i<25;i++){
    let cell=document.createElement("div");
    cell.className="mine-cell disabled";
    cell.dataset.mine=mines.includes(i);
    cell.onclick=()=>clickMine(cell);
    grid.appendChild(cell);
  }
}
function clickMine(cell){
  if(!minesActive||cell.classList.contains("revealed")) return;
  cell.classList.add("revealed");
  if(cell.dataset.mine==="true"){
    cell.classList.add("mine"); document.getElementById("minesStatus").innerText="üí• –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏!"; minesLost=true; minesActive=false;
  } else {
    cell.classList.add("safe"); mineMultiplier+=0.5; document.getElementById("mineReward").innerText="–í—ã–∏–≥—Ä—ã—à: "+(currentStake*mineMultiplier).toFixed(2);
  }
}
function startMines(){
  const stakeType=document.querySelector('input[name="stakeType"]:checked').value;
  let stake=stakeType==="ton"?parseFloat(document.getElementById("tonStake").value):null;
  if(stakeType==="ton"&&!stake){alert("–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É"); return;}
  if(stakeType==="ton"&&balance<stake){alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"); return;}
  if(stakeType==="ton"){balance-=stake; updateBalance();}
  currentStake=stake; mineMultiplier=1; minesLost=false; minesActive=true;
  generateMines(); document.querySelectorAll(".mine-cell").forEach(c=>c.classList.remove("disabled"));
  document.getElementById("mineReward").innerText="–í—ã–∏–≥—Ä—ã—à: ‚Äì"; document.getElementById("minesStatus").innerText="";
}
function collectReward(){
  if(!minesActive&&!minesLost&&currentStake>0){
    let win=currentStake*mineMultiplier;
    if(win>=1.5){
      let gift=getGiftByPrice(win); inventory.push(gift); renderInventory(); alert("–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –ø–æ–¥–∞—Ä–æ–∫: "+gift.name);
    } else {
      balance+=win; updateBalance(); alert("–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ "+win.toFixed(2)+" TON");
    }
  }
  minesActive=false; currentStake=0; document.getElementById("mineReward").innerText="–í—ã–∏–≥—Ä—ã—à: ‚Äì";
}

// === –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ ===
function preloadAssets(){
  const bgImages=Object.values(backgrounds).map(src=>new Promise(res=>{const img=new Image();img.onload=res;img.onerror=res;img.src=src;}));
  Promise.all(bgImages).then(()=>{
    document.getElementById('loader').classList.add('hidden');
    document.body.style.opacity='1';
    updateBalance();
    generateMineGrid();
    generateMines();
    let sel=document.getElementById('giftStake');
    gifts.forEach(g=>{let o=document.createElement('option');o.value=g.name;o.textContent=`${g.name} (${g.price} TON)`;sel.appendChild(o);});
    showTab('menu');
  });
}
window.onload=()=>{preloadAssets();};

function updateStakeInput(){
  let type=document.querySelector('input[name="stakeType"]:checked').value;
  document.getElementById('tonStake').style.display=type==="ton"?"inline-block":"none";
  document.getElementById('giftStake').style.display=type==="gift"?"inline-block":"none";
}
</script>
</body>
</html>
